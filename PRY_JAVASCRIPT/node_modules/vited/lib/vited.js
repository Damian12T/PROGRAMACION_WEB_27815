"use strict";Object.defineProperty(exports,"__esModule",{value:!0}),exports.run=void 0;var _path=_interopRequireDefault(require("path")),_fs=_interopRequireDefault(require("fs")),_process=_interopRequireDefault(require("process")),_chalk=_interopRequireDefault(require("chalk")),_glob=_interopRequireDefault(require("glob")),_vite=require("vite"),_address=_interopRequireDefault(require("address")),_pluginReactSwc=_interopRequireDefault(require("@vitejs/plugin-react-swc")),_tpl=_interopRequireDefault(require("./tpl"));function _interopRequireDefault(a){return a&&a.__esModule?a:{default:a}}var __assign=function(){return __assign=Object.assign||function(a){for(var b,c=1,d=arguments.length;c<d;c++)for(var e in b=arguments[c],b)Object.prototype.hasOwnProperty.call(b,e)&&(a[e]=b[e]);return a},__assign.apply(this,arguments)},__awaiter=function(a,b,c,d){function e(a){return a instanceof c?a:new c(function(b){b(a)})}return new(c||(c=Promise))(function(c,f){function g(a){try{i(d.next(a))}catch(a){f(a)}}function h(a){try{i(d["throw"](a))}catch(a){f(a)}}function i(a){a.done?c(a.value):e(a.value).then(g,h)}i((d=d.apply(a,b||[])).next())})},__generator=function(a,b){function c(a){return function(b){return d([a,b])}}function d(c){if(e)throw new TypeError("Generator is already executing.");for(;j&&(j=0,c[0]&&(k=0)),k;)try{if(e=1,h&&(i=2&c[0]?h["return"]:c[0]?h["throw"]||((i=h["return"])&&i.call(h),0):h.next)&&!(i=i.call(h,c[1])).done)return i;switch((h=0,i)&&(c=[2&c[0],i.value]),c[0]){case 0:case 1:i=c;break;case 4:return k.label++,{value:c[1],done:!1};case 5:k.label++,h=c[1],c=[0];continue;case 7:c=k.ops.pop(),k.trys.pop();continue;default:if((i=k.trys,!(i=0<i.length&&i[i.length-1]))&&(6===c[0]||2===c[0])){k=0;continue}if(3===c[0]&&(!i||c[1]>i[0]&&c[1]<i[3])){k.label=c[1];break}if(6===c[0]&&k.label<i[1]){k.label=i[1],i=c;break}if(i&&k.label<i[2]){k.label=i[2],k.ops.push(c);break}i[2]&&k.ops.pop(),k.trys.pop();continue;}c=b.call(a,k)}catch(a){c=[6,a],h=0}finally{e=i=0}if(5&c[0])throw c[1];return{value:c[0]?c[1]:void 0,done:!0}}var e,h,i,j,k={label:0,sent:function sent(){if(1&i[0])throw i[1];return i[1]},trys:[],ops:[]};return j={next:c(0),throw:c(1),return:c(2)},"function"==typeof Symbol&&(j[Symbol.iterator]=function(){return this}),j},__spreadArray=function(a,b,c){if(c||2===arguments.length)for(var d,e=0,f=b.length;e<f;e++)(d||!(e in b))&&(d||(d=Array.prototype.slice.call(b,0,e)),d[e]=b[e]);return a.concat(d||Array.prototype.slice.call(b))},getProjectPath=function getProjectPath(a){return void 0===a&&(a="./"),(0,_vite.normalizePath)(_path.default.join(_process.default.cwd(),a))};function exit(a){console.log(_chalk.default.red(a)),_process.default.exit(9)}//#endregion
var defaultConfig={configFile:!1,envFile:!1,base:"/",resolve:{alias:{"~":getProjectPath("./src"),"@":getProjectPath("./src")}}},run=function run(a,b,c){var d=_glob.default.sync("./src/index{.jsx,.js,.ts,.tsx}");d.length||exit("\u5165\u53E3\u6587\u4EF6\u4E0D\u5B58\u5728: ".concat(getProjectPath("./src/index")));var e=d[0],f=getProjectPath("./index.html");_fs.default.existsSync(f)||(_fs.default.writeFileSync(f,(0,_tpl.default)(e)),console.log(_chalk.default.green("index.html \u5DF2\u521B\u5EFA")));var g=b.plugins,h=void 0===g?[(0,_pluginReactSwc.default)()]:g,i=b.server,j=void 0===i?{}:i,k=b.build,l=void 0===k?{}:k,m=b.css,n=void 0===m?{preprocessorOptions:{less:{relativeUrls:!1,javascriptEnabled:!0}}}:m,o=__assign(__assign(__assign({},defaultConfig),b),{css:n});o.plugins=__spreadArray([],h,!0),a?(o.server=__assign({port:3e3,host:"0.0.0.0",open:!0,strictPort:!0},j),function(){return __awaiter(void 0,void 0,void 0,function(){var a,b,c,d;return __generator(this,function(e){switch(e.label){case 0:return[4/*yield*/,(0,_vite.createServer)(o)];case 1:return a=e.sent(),[4/*yield*/,a.listen()];case 2:return e.sent(),b=o.server.port,c="http://localhost:".concat(b),d="http://".concat(_address.default.ip(),":").concat(b),console.log(),console.log(_chalk.default.cyan("dev server running at:")),console.log(),console.log("> Local:",_chalk.default.green("".concat(c))),console.log(),console.log("> Network:",_chalk.default.green("".concat(d))),[2/*return*/];}})})}()):(o.build=__assign({emptyOutDir:!0,assetsInlineLimit:10240},l),function(){return __awaiter(void 0,void 0,void 0,function(){return __generator(this,function(a){switch(a.label){case 0:return[4/*yield*/,(0,_vite.build)(o).then(function(){null===c||void 0===c?void 0:c()})];case 1:return a.sent(),[2/*return*/];}})})}())};/**
 * 自定义开发/编译配置
 *
 * @param {boolean} isDev 是否开发环境
 * @param {UserConfig} options vite配置
 * @param {() => void} [callback] 编译结束后的回调
 */exports.run=run;